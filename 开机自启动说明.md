# 工作流系统开机自启动配置说明

## 📋 概述

本系统提供了完整的开机自启动解决方案，让您无需每次重启后手动启动服务。

## 🚀 快速配置

### 方法一：一键配置（推荐）

1. **右键点击** `配置开机自启动.bat`
2. 选择 **"以管理员身份运行"**
3. 等待配置完成
4. 重启电脑验证

### 方法二：手动配置

如果一键配置失败，可以按以下步骤手动配置：

#### 1. 配置 MongoDB 开机自启

```cmd
sc config MongoDB start=auto
```

#### 2. 配置 PM2 开机自启

```cmd
# 全局安装 pm2-windows-startup
npm install -g pm2-windows-startup

# 安装开机启动服务
pm2-startup install

# 确保后端服务在 PM2 中
cd backend
pm2 start server.js --name "oa-backend"

# 保存 PM2 配置
pm2 save
```

#### 3. 配置 Cloudflare Tunnel 开机自启

1. 打开 **任务计划程序**（按 `Win+R`，输入 `taskschd.msc`）
2. 点击 **"创建任务"**
3. 配置如下：
   - **常规** 标签页：
     - 名称：`Cloudflare Tunnel - OA Backend`
     - 勾选：使用最高权限运行
   - **触发器** 标签页：
     - 新建触发器：用户登录时
     - 延迟任务时间：30 秒
   - **操作** 标签页：
     - 程序或脚本：`cloudflared`
     - 参数：`tunnel run oa-backend`
   - **条件** 标签页：
     - 取消勾选：只有在使用交流电源时才启动此任务
   - **设置** 标签页：
     - 勾选：如果任务失败，重新启动
     - 勾选：如果请求后任务还在运行，强行将其停止

## ⚙️ 服务启动顺序

开机后服务启动的顺序和时间：

1. **MongoDB** - 立即启动（Windows 服务）
2. **PM2 后端服务** - 延迟 30 秒启动
3. **Cloudflare Tunnel** - 延迟 30 秒启动

> 💡 **为什么要延迟？**
> 延迟启动是为了确保网络连接已建立，避免启动失败。

## 🔍 验证配置

### 1. 检查 MongoDB

```cmd
sc query MongoDB
# 应该显示 STATE: 4 RUNNING
# 和 START_TYPE: 2 AUTO_START
```

### 2. 检查 PM2

```cmd
pm2 status
# 应该显示 oa-backend 服务正在运行
```

### 3. 检查 Cloudflare Tunnel

```cmd
tasklist | find "cloudflared"
# 应该显示 cloudflared.exe 进程
```

### 4. 检查任务计划

```cmd
schtasks /query /tn "Cloudflare Tunnel - OA Backend"
# 应该显示任务已启用
```

## 🛠️ 管理命令

### 查看服务状态

```cmd
# 查看所有服务
pm2 status

# 查看后端日志
pm2 logs oa-backend

# 查看最近 200 行日志
pm2 logs oa-backend --lines 200
```

### 重启服务

```cmd
# 重启后端服务
pm2 restart oa-backend

# 重启所有 PM2 服务
pm2 restart all
```

### 停止服务

```cmd
# 停止后端服务
pm2 stop oa-backend

# 停止所有服务（运行 停止后端服务.bat）
```

## ❌ 取消开机自启动

如果您不想再使用开机自启动：

1. **右键点击** `取消开机自启动.bat`
2. 选择 **"以管理员身份运行"**

或手动取消：

```cmd
# 取消 MongoDB 自启
sc config MongoDB start=demand

# 取消 PM2 自启
pm2-startup uninstall

# 取消 Cloudflare Tunnel 自启
schtasks /delete /tn "Cloudflare Tunnel - OA Backend" /f
```

## 🐛 故障排查

### 问题 1: MongoDB 启动失败

**解决方案：**
```cmd
# 手动启动 MongoDB
net start MongoDB

# 或
Start-Service MongoDB
```

### 问题 2: PM2 服务未启动

**解决方案：**
```cmd
# 重新配置 PM2
pm2 resurrect

# 如果不行，手动启动
cd backend
pm2 start server.js --name "oa-backend"
pm2 save
```

### 问题 3: Cloudflare Tunnel 未启动

**解决方案：**
```cmd
# 检查 cloudflared 是否安装
cloudflared --version

# 手动启动
cloudflared tunnel run oa-backend

# 检查任务计划
taskschd.msc
```

### 问题 4: 开机后服务启动太慢

**解决方案：**
- 延迟是正常的（30秒），这是为了等待网络连接
- 如果超过 2 分钟还未启动，检查服务日志
- 运行 `pm2 logs oa-backend` 查看错误信息

## 📌 注意事项

1. ⚠️ **必须以管理员身份运行**配置脚本
2. ⚠️ **确保 Node.js、PM2、Cloudflared 已正确安装**
3. ⚠️ **防火墙可能会阻止服务启动**，请添加允许规则
4. ⚠️ **用户密码更改后**，可能需要重新配置任务计划
5. ✅ **建议定期检查**服务运行状态

## 📊 系统要求

- Windows 10 或更高版本
- 管理员权限
- Node.js 已安装
- PM2 已全局安装 (`npm install -g pm2`)
- MongoDB 已安装为 Windows 服务
- Cloudflared 已安装并配置

## 🔗 相关文件

- `配置开机自启动.bat` - 一键配置开机自启
- `取消开机自启动.bat` - 取消开机自启
- `启动后端服务.bat` - 手动启动服务
- `停止后端服务.bat` - 停止所有服务
- `检查服务状态.bat` - 检查服务运行状态

## 💡 最佳实践

1. **首次配置后重启验证** - 确保所有服务正常启动
2. **定期检查日志** - 使用 `pm2 logs` 监控服务健康
3. **备份 PM2 配置** - `pm2 save` 保存当前配置
4. **监控系统资源** - 确保服务不会占用过多资源

## 🆘 获取帮助

如果遇到问题：

1. 查看 `pm2 logs oa-backend` 日志
2. 检查 Windows 事件查看器
3. 运行 `检查服务状态.bat` 诊断问题
4. 参考 `问题排查指南.md`

---

**配置完成后，您再也不用每次重启都手动启动服务了！** 🎉

