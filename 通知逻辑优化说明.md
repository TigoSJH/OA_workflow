# 🔔 通知逻辑优化说明

## 📋 问题描述

**用户反馈：**
- 经常收到"项目xx已下发"、"项目xx已完成时间安排并下发"的通知
- 但项目还没推送到自己的部门页面
- 无法查看项目，造成困扰

---

## 🐛 原因分析

### 旧的通知逻辑（有问题）

**项目批准时：**
```
项目批准 
  → 通知主负责人"请设置时间周期"✅ 正确
  → 通知所有研发人员"项目已启动"❌ 错误（此时主负责人还没设置时间）
```

**设置时间周期时：**
```
主负责人设置时间周期
  → 通知所有角色（研发、工程、采购、加工、装配、调试、库管）❌ 错误
     问题：后续阶段的人还不需要工作，收到通知却看不到项目
```

---

## ✅ 优化后的通知逻辑

### 1. 项目批准时
```
项目批准 
  → 只通知主负责人"请设置时间周期" ✅
  → 不再通知其他任何人 ✅
```

### 2. 设置时间周期时
```
主负责人设置时间周期
  → 只通知研发人员"新项目已下发，请及时完成研发工作" ✅
  → 不通知其他角色 ✅
```

### 3. 后续阶段通知（保持不变）
```
研发完成 → 通知工程人员
工程完成 → 通知采购人员
...
（每个阶段完成后，自动通知下一阶段负责人）
```

---

## 📊 通知时机对照表

| 时机 | 旧逻辑 | 新逻辑 |
|------|--------|--------|
| 项目批准 | 通知主负责人 + 研发人员 ❌ | 只通知主负责人 ✅ |
| 设置时间周期 | 通知所有7个角色 ❌ | 只通知研发人员 ✅ |
| 研发完成 | 通知工程人员 ✅ | 通知工程人员 ✅ |
| 工程完成 | 通知采购人员 ✅ | 通知采购人员 ✅ |
| ... | ... | ... |

---

## 🔧 修改的文件

### 1. `backend/controllers/newProjectController.js`
**删除：** 项目批准时对研发人员的通知

```javascript
// 旧代码（已删除）
// 为所有研发人员创建通知
try {
  const researchers = await User.find({ 
    roles: 'researcher',
    status: 'approved'
  });
  
  const notificationPromises = researchers.map(researcher => {
    return new Notification({
      toUserId: researcher._id,
      type: 'project_started',
      title: '项目启动通知',
      message: `${approvedProject.projectName} 项目已启动，请及时完成设计`,
      projectId: approvedProject._id
    }).save();
  });
  
  await Promise.all(notificationPromises);
} catch (notifError) { ... }
```

**新代码：**
```javascript
// 注意：不在此处通知研发人员，而是等主负责人设置完时间周期后再通知
// 避免研发人员收到通知但看不到项目的问题
```

---

### 2. `backend/controllers/projectController.js`
**修改：** 设置时间周期时只通知研发人员

**旧代码：**
```javascript
// 定义需要通知的角色
const rolesToNotify = ['researcher', 'engineer', 'purchaser', 'processor', 'assembler', 'tester', 'warehouse'];

// 获取所有相关角色的用户
const usersToNotify = await User.find({
  roles: { $in: rolesToNotify },
  status: 'approved'
});

// 通知消息
title: '新项目已下发',
message: `项目"${project.projectName}"已完成时间安排并下发，请及时处理`,
requiresAction: false
```

**新代码：**
```javascript
// 只通知研发人员，后续阶段会在前一阶段完成时自动通知
const rolesToNotify = ['researcher'];

// 获取所有研发人员
const usersToNotify = await User.find({
  roles: { $in: rolesToNotify },
  status: 'approved'
});

// 通知消息
title: '新项目已下发',
message: `项目"${project.projectName}"已完成时间安排并下发，请及时完成研发工作`,
requiresAction: true
```

---

## 🎯 优化效果

### 优化前
- ❌ 研发人员：收到2次通知（批准时+设置时间时）
- ❌ 工程人员：收到1次通知（设置时间时），但项目还没到工程阶段
- ❌ 采购人员：收到1次通知（设置时间时），但项目还没到采购阶段
- ❌ 其他角色：同样收到不必要的通知

### 优化后
- ✅ 主负责人：批准时收到通知，知道需要设置时间周期
- ✅ 研发人员：设置时间时收到通知，可以立即开始工作
- ✅ 其他角色：只在轮到自己时才收到通知，不会提前收到

---

## 📝 用户体验改进

### 1. 通知更精准
- 只在真正需要你工作时才通知
- 不会收到无法查看的项目通知

### 2. 减少干扰
- 减少不必要的通知数量
- 提高工作效率

### 3. 逻辑更清晰
- 通知时机与工作流程完全匹配
- 收到通知就能立即在自己页面看到项目

---

## 🚀 部署状态

✅ 已推送到 GitHub (commit 6d9b675)
✅ 已重启后端服务（PM2）
✅ 立即生效

---

## 🧪 测试建议

**创建新项目测试：**

1. **立项并批准**
   - 主负责人应该收到"请设置时间周期"通知 ✅
   - 研发人员不应该收到任何通知 ✅

2. **设置时间周期**
   - 研发人员应该收到"新项目已下发"通知 ✅
   - 其他角色不应该收到通知 ✅

3. **研发完成**
   - 工程人员应该收到通知 ✅
   - 研发人员不应该再收到通知 ✅

4. **后续流程**
   - 每个阶段完成后，下一阶段负责人才收到通知 ✅

---

**测试完成后，通知流程应该是这样的：**

```
立项批准
  ↓
主负责人收到通知 ← 只有主负责人
  ↓
设置时间周期
  ↓
研发人员收到通知 ← 只有研发人员
  ↓
研发完成
  ↓
工程人员收到通知 ← 只有工程人员
  ↓
工程完成
  ↓
采购人员收到通知 ← 只有采购人员
  ↓
...（依此类推）
```

每个人只在轮到自己时收到通知，不会提前收到无法处理的通知！🎉

