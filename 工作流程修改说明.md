# 📋 工作流程修改说明

## 🔄 修改概述

本次修改调整了项目的入库-出库流程，使其符合实际业务需求：装配调试后的整机需要再次经过入库和出库确认流程。

---

## 📊 新旧流程对比

### ❌ 旧流程
```
加工完成 → 入库 → 装配 → 调试 → 出库 → 结束
```

### ✅ 新流程
```
加工完成 → 第一次入库（零件入库）
           ↓
      第一次出库（领料）
           ↓
         装配
           ↓
         调试
           ↓
    第二次入库（整机入库）
           ↓
  第二次出库（整机出库确认）
           ↓
      归档（管理员）
```

---

## 🔧 修改详情

### 1. 数据库模型修改

#### 文件：`backend/models/Project.js` 和 `backend/models/ApprovedProject.js`

**新增字段：**

```javascript
// 第二次入库阶段相关（整机入库）
warehouseInSecondCompleted: {
  type: Boolean,
  default: false
},
warehouseInSecondCompletedTime: {
  type: Date
},
warehouseInSecondCompletedBy: {
  type: String
},

// 第二次出库阶段相关（整机出库确认）
warehouseOutSecondCompleted: {
  type: Boolean,
  default: false
},
warehouseOutSecondCompletedTime: {
  type: Date
},
warehouseOutSecondCompletedBy: {
  type: String
}
```

---

### 2. 后端控制器修改

#### 文件：`backend/controllers/newProjectController.js`

**新增通知流程：**

1. **第一次入库完成 → 第一次出库**
   ```javascript
   if (updateData.warehouseInCompleted === true && !project.warehouseInCompleted) {
     // 通知库管进行第一次出库（领料）
   }
   ```

2. **第一次出库完成 → 装配**
   ```javascript
   if (updateData.warehouseOutCompleted === true && !project.warehouseOutCompleted) {
     // 通知装配人员
   }
   ```

3. **调试完成 → 第二次入库（整机入库）**
   ```javascript
   if (updateData.testingCompleted === true && !project.testingCompleted) {
     // 通知库管进行第二次入库（整机入库）
     type: 'project_ready_for_warehousein_second'
   }
   ```

4. **第二次入库完成 → 第二次出库**
   ```javascript
   if (updateData.warehouseInSecondCompleted === true && !project.warehouseInSecondCompleted) {
     // 通知库管进行第二次出库（整机出库确认）
     type: 'project_ready_for_warehouseout_second'
   }
   ```

5. **第二次出库完成 → 归档**
   ```javascript
   if (updateData.warehouseOutSecondCompleted === true && !project.warehouseOutSecondCompleted) {
     // 通知管理员归档项目
     type: 'project_ready_for_archive'
   }
   ```

---

### 3. 前端组件修改

#### 3.1 入库详情页 - `workflow-web/src/components/WarehouseInDetail.js`

**主要修改：**

- 自动判断是第一次还是第二次入库
  ```javascript
  const isSecondWarehouseIn = project.testingCompleted === true && 
                              project.warehouseInCompleted === true;
  ```

- 根据入库类型动态显示不同的文案：
  - 第一次入库：显示"入库完成，推送到出库阶段"
  - 第二次入库：显示"整机入库完成，推送到出库确认阶段"

- 根据入库类型更新不同的字段：
  - 第一次：`warehouseInCompleted`
  - 第二次：`warehouseInSecondCompleted`

#### 3.2 出库详情页 - `workflow-web/src/components/WarehouseOutDetail.js`

**主要修改：**

- 自动判断是第一次还是第二次出库
  ```javascript
  const isSecondWarehouseOut = project.warehouseInSecondCompleted === true && 
                               project.warehouseOutCompleted === true;
  ```

- 根据出库类型动态显示不同的文案：
  - 第一次出库：显示"出库完成，推送到装配阶段"
  - 第二次出库：显示"出库完成，转交给项目主管归档"

- 根据出库类型更新不同的字段：
  - 第一次：`warehouseOutCompleted`
  - 第二次：`warehouseOutSecondCompleted`

#### 3.3 入库项目列表 - `workflow-web/src/components/ProjectWarehouseIn.js`

**修改项目过滤逻辑：**

```javascript
const warehouseInProjects = (response.projects || []).filter(p => {
  // 第一次入库：加工已完成 && 第一次入库未完成
  const firstWarehouseIn = p.processingCompleted === true && !p.warehouseInCompleted;
  // 第二次入库：调试已完成 && 第二次入库未完成
  const secondWarehouseIn = p.testingCompleted === true && 
                            p.warehouseInCompleted === true && 
                            !p.warehouseInSecondCompleted;
  return firstWarehouseIn || secondWarehouseIn;
});
```

**通知类型过滤：**
- 同时监听 `project_ready_for_warehousein` 和 `project_ready_for_warehousein_second`

#### 3.4 出库项目列表 - `workflow-web/src/components/ProjectWarehouseOut.js`

**修改项目过滤逻辑：**

```javascript
const warehouseOutProjects = (response.projects || []).filter(p => {
  // 第一次出库：第一次入库已完成 && 第一次出库未完成
  const firstWarehouseOut = p.warehouseInCompleted === true && !p.warehouseOutCompleted;
  // 第二次出库：第二次入库已完成 && 第二次出库未完成
  const secondWarehouseOut = p.warehouseInSecondCompleted === true && 
                             p.warehouseOutCompleted === true && 
                             !p.warehouseOutSecondCompleted;
  return firstWarehouseOut || secondWarehouseOut;
});
```

**通知类型过滤：**
- 同时监听 `project_ready_for_warehouseout` 和 `project_ready_for_warehouseout_second`

---

## 🎯 新增通知类型

| 通知类型 | 说明 | 接收角色 |
|---------|------|---------|
| `project_ready_for_warehousein` | 第一次入库通知（零件入库） | warehouse |
| `project_ready_for_warehouseout` | 第一次出库通知（领料） | warehouse |
| `project_ready_for_warehousein_second` | 第二次入库通知（整机入库） | warehouse |
| `project_ready_for_warehouseout_second` | 第二次出库通知（整机出库确认） | warehouse |
| `project_ready_for_archive` | 归档通知 | manager |

---

## 📝 用户操作说明

### 库管人员

#### 第一次入库（零件入库）
1. 收到通知：项目已完成加工
2. 进入项目详情，完成零件入库
3. 点击"入库完成，推送到出库阶段"

#### 第一次出库（领料）
1. 收到通知：项目已完成入库
2. 进入项目详情，安排出库领料
3. 点击"出库完成，推送到装配阶段"

#### 第二次入库（整机入库）
1. 收到通知：项目已完成调试
2. 进入项目详情，完成整机入库
3. 点击"整机入库完成，推送到出库确认阶段"

#### 第二次出库（整机出库确认）
1. 收到通知：项目已完成整机入库
2. 进入项目详情，确认整机出库
3. 点击"出库完成，转交给项目主管归档"

### 管理员

#### 项目归档
1. 收到通知：项目已完成所有流程
2. 进入项目详情，填写归档总结
3. 完成项目归档

---

## 🚀 部署步骤

### 1. 后端部署（办公室服务器）

```powershell
# 1. 停止后端服务
cd E:\workflow-web-main\workflow-web-main\backend
pm2 stop all

# 2. 拉取最新代码（如果使用 Git）
git pull origin main

# 3. 重启后端服务
pm2 start server.js --name "oa-backend"

# 4. 检查服务状态
pm2 status
pm2 logs
```

### 2. 前端部署（Cloudflare Pages）

```powershell
# 1. 进入前端目录
cd E:\workflow-web-main\workflow-web-main

# 2. 提交代码
git add .
git commit -m "更新工作流程：添加两次入库/出库流程"
git push origin main

# 3. Cloudflare Pages 会自动部署（3-5分钟）
```

### 3. 验证部署

#### 后端验证
```powershell
# 检查后端服务
pm2 status

# 查看后端日志
pm2 logs oa-backend --lines 50
```

#### 前端验证
1. 访问 https://oa.jjkjoa.top/
2. 强制刷新浏览器（Ctrl + Shift + R）
3. 测试完整工作流程

---

## ⚠️ 注意事项

### 1. 数据兼容性
- **旧项目不受影响**：新增字段默认为 `false`，不影响已有项目
- **MongoDB 自动更新**：Mongoose 会自动为新文档添加新字段

### 2. 测试建议
建议测试完整流程：
1. 创建新项目（研发立项）
2. 工程设计完成
3. 采购完成
4. 加工完成
5. **第一次入库** ✅
6. **第一次出库** ✅
7. 装配完成
8. 调试完成
9. **第二次入库（整机）** ✅
10. **第二次出库（确认）** ✅
11. 管理员归档 ✅

### 3. 已知限制
- 装配和调试阶段不支持多次入库/出库
- 归档后的项目无法再次修改

---

## 🐛 故障排查

### 问题1：收不到第二次入库/出库通知
**解决方案：**
- 检查后端日志：`pm2 logs oa-backend`
- 确认项目状态：调试是否已完成
- 检查用户角色：是否为 `warehouse`

### 问题2：前端显示异常
**解决方案：**
- 清除浏览器缓存（Ctrl + Shift + R）
- 检查浏览器控制台错误（F12）
- 确认 Cloudflare Pages 部署成功

### 问题3：项目卡在某个阶段
**解决方案：**
- 检查数据库字段：`warehouseInCompleted`, `warehouseOutCompleted` 等
- 使用 MongoDB Compass 查看项目状态
- 必要时手动更新项目状态

---

## 📞 技术支持

如有问题，请检查：
1. 后端日志：`pm2 logs`
2. MongoDB 连接：检查 `.env` 中的 `MONGODB_URI`
3. Cloudflare Tunnel：`cloudflared tunnel run oa-backend`

---

## ✅ 修改完成清单

- [x] 数据库模型添加第二次入库/出库字段
- [x] 后端控制器添加新的通知流程
- [x] 前端入库组件支持两次入库
- [x] 前端出库组件支持两次出库
- [x] 入库项目列表过滤逻辑
- [x] 出库项目列表过滤逻辑
- [x] 通知类型过滤逻辑
- [x] 代码无 linter 错误
- [ ] 完整流程测试（待用户验证）

---

**修改日期**：2025-10-24  
**修改人员**：AI Assistant  
**版本**：v2.0

